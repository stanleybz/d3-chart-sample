<!DOCTYPE html><!DOCTYPE html>
<html lang=zh>
    <meta charset=utf-8>
    <meta content="width=device-width,initial-scale=1" name=viewport>
    <title>Relationship Visualization</title>
    <meta content=D3.js,4.0,relationship,关系图 name=keywords>
    <meta content="" name=description>
    <link href=./css/relationship.css rel=stylesheet>
    <div>
        <canvas height=1500 width=1500></canvas>
        <script
          src="https://code.jquery.com/jquery-3.2.1.min.js"
          integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
          crossorigin="anonymous"></script>
        <script src=js/d3.min.js></script>
        <script src=relation.js></script>
        <script>



            var canvas = document.querySelector("canvas")
              , width = 1500
              , height = 1500;

            d3.json("http://antimatter.wemine.net/store/at_wemine_cn_demo_wheel?per_page=1000", function(r, o){

              var maxColor = 255;
              var minColor = 80;
              var stage = 0;
              var colorArray = [[255,85,85]];

              for (var i=0; i<1000; i++) {
                var thisColor = Object.assign([], colorArray[colorArray.length-1]);
                if (stage == 0) {
                  thisColor[2] = thisColor[2]+3;
                  colorArray.push(thisColor);
                  if (thisColor[2] == 255) stage = 1
                }
                if (stage == 1) {
                  thisColor[0] = thisColor[0]-3;
                  colorArray.push(thisColor);
                  if (thisColor[0] == 5) stage = 2
                }
                if (stage == 2) {
                  thisColor[1] = thisColor[1]+3;
                  colorArray.push(thisColor);
                  if (thisColor[1] == 255) stage = 3
                }
                if (stage == 3) {
                  thisColor[2] = thisColor[2]-3;
                  colorArray.push(thisColor);
                  if (thisColor[2] == 5) stage = 4
                }
                if (stage == 4) {
                  thisColor[0] = thisColor[0]+3;
                  colorArray.push(thisColor);
                  if (thisColor[0] == 255) stage = 5
                }
                if (stage == 5) {
                  thisColor[1] = thisColor[1]-3;
                  colorArray.push(thisColor);
                  if (thisColor[1] == 5) stage = 6
                }
              }

              console.log(colorArray);
              var colorSelect = 0;
              var allData  = o.data.data;
              var nodes = {
                0: {"id":"0","name":"Origin",color: "rgb(255,255,255)",radius: 20},
                1: {"id":"1","name":"Unknown",color: "rgb("+colorArray[colorSelect][0]+","+colorArray[colorSelect][1]+","+colorArray[colorSelect][2]+")",radius: 10}
              };
              var link = [];
              var followerList = [];
              var count = 1;
              var follower = [];

              /*
              * Getting node data
              */
              var settings = {
                "async": true,
                "crossDomain": true,
                "url": "http://api.wemine.net/follower?per_page=1000",
                "method": "GET",
                "headers": {
                  "authorization-x": "eyJ0eXAiOiJKV1QiLCJhbGciOiJIUzI1NiJ9.eyJhY2NvdW50X2lkIjoyNiwiZW1haWwiOiJyYS13ZW1pbmUtZGVtbyIsInVzZXJuYW1lIjoicmEtd2VtaW5lLWRlbW8iLCJjb21wYW55X25hbWUiOiJXZW1pbmUgRGVtbyIsImNvbXBhbnlfbG9nbyI6Imh0dHBzOlwvXC9yb2xsYW5nbGUuY29tXC93cC1jb250ZW50XC91cGxvYWRzXC8yMDEzXC8xMlwvcmFfbG9nby5wbmciLCJjb19pZCI6IndlbWluZV9kZW1vIiwicm9sZSI6MCwicGVybWlzc2lvbiI6WyJob21lIiwibWVudU1hbmFnZW1lbnQiLCJhdXRvUmVwbHkiLCJtZWRpYU5ld3MiLCJncm91cE1hbmFnZW1lbnQiLCJ0YWdNYW5hZ2VtZW50IiwiZm9sbG93ZXJNYW5hZ2VtZW50IiwibWVkaWFNYW5hZ2VtZW50IiwibWVzc2FnZU1hbmFnZW1lbnQiXSwibGFzdF9sb2dpbiI6IjIwMTctMTEtMjMgMTY6MDA6MzMiLCJpcF9udW1iZXIiOjM3NTQyOTA1NjMsImJyb3dzZXJfbmFtZSI6Ikdvb2dsZSBDaHJvbWU2Mi4wLjMyMDIuOTQifQ.B_7R55lMtCk2i9xvZTa9dCcsaUp-iNPCAd1QxEZqiRI",
                  "cache-control": "no-cache",
                  "postman-token": "389b4448-fee9-e227-ad85-8511ae211b26"
                }
              }

              $.ajax(settings).done(function (response) {
                var allFollower = response.data.data;
                for (var key in allFollower) {
                  followerList.push(allFollower[key].wechat_id);
                  nodes[allFollower[key].wechat_id] =
                    {
                      id: allFollower[key].wechat_id,
                      name: allFollower[key].nickname,
                      color: "rgb(255, 113, 255)",
                      radius: 10
                    }
                }

                /*
                * Setting nodes link
                */
                for (var key in allData) {
                  var thisData = JSON.parse(allData[key].value);
                  if (thisData.type === 'open') {
                    if (thisData.from == '' && thisData.to == '') {
                      // Do nothing
                    }
                    else if (thisData.from == '') {
                      link.push({
                        source: '0',
                        target: thisData.to,
                      });
                      nodes[thisData.to].color = "rgb("+colorArray[colorSelect][0]+","+colorArray[colorSelect][1]+","+colorArray[colorSelect][2]+")";
                      nodes[thisData.to].radius = nodes[thisData.to].radius + 0.5;
                    }
                    else if (followerList.indexOf(thisData.from) == -1) {
                      link.push({
                        source: '1',
                        target: thisData.to,
                      });
                      nodes[thisData.to].color = "rgb("+colorArray[colorSelect][0]+","+colorArray[colorSelect][1]+","+colorArray[colorSelect][2]+")";
                      nodes[thisData.to].radius = nodes[thisData.to].radius + 0.5;
                    }
                    else if (followerList.indexOf(thisData.to) == -1) {
                      link.push({
                        source: thisData.from,
                        target: '1',
                      });
                      nodes[thisData.from].color = "rgb("+colorArray[colorSelect][0]+","+colorArray[colorSelect][1]+","+colorArray[colorSelect][2]+")";
                      nodes[thisData.from].radius = nodes[thisData.from].radius + 0.5;
                    }
                    else {
                      link.push({
                        source: thisData.from,
                        target: thisData.to,
                      });
                      nodes[thisData.to].color = "rgb("+colorArray[colorSelect][0]+","+colorArray[colorSelect][1]+","+colorArray[colorSelect][2]+")";
                      nodes[thisData.from].color = "rgb("+colorArray[colorSelect][0]+","+colorArray[colorSelect][1]+","+colorArray[colorSelect][2]+")";

                      nodes[thisData.to].radius = nodes[thisData.to].radius + 0.5;
                      nodes[thisData.from].radius = nodes[thisData.from].radius + 0.5;
                    }
                  }
                  colorSelect++;
                }

                console.log('node', nodes);

                var node_array = [];
                // Convert nodes object to array
                for (var node in nodes) {
                    node_array.push(nodes[node]);
                }

                console.log(link, node_array);
                console.log('follower list', followerList);

                var s = new relation;
                s.setNodes(node_array),
                s.setLinks(link),
                s.setCanvas(canvas),
                s.setSize(width, height),
                s.setRadius(20),
                s.setLinkLength(200),
                s.setCharge(-200),
                s.init(),
                s.run()


              });


            });

            // d3.csv("./nodes.csv", function(r, o) {
            //     for (var t = (o.length, 4), i = [], e = 1; e <= t; e++) {
            //         console.log(t);
            //         i.push({
            //             source: 0,
            //             target: e
            //         });
            //     }
            //
            //     for (var e = t + 1; e < o.length; e++) {
            //         i.push({
            //             source: e % t + 1,
            //             target: e
            //         });
            //     }
            //
            //     initColor(o),
            //     initRadius(o);
            //
            //     console.log(JSON.stringify(o) ,JSON.stringify(i));
            //     var s = new relation;
            //     s.setNodes([{"id":"0","name":"Geoff","color":"#007FFF","radius":108},{"id":"1","name":"School","color":"#A142FF","radius":14},{"id":"2","name":"Company","color":"#FF85C2","radius":14},{"id":"3","name":"Family","color":"#FFA142","radius":14},{"id":"4","name":"Network","color":"#FF4242","radius":14},{"id":"5","name":"Aaron","color":"rgb(255, 227, 255)","radius":10},{"id":"6","name":"Abbott","color":"rgb(255, 255, 113)","radius":10},{"id":"7","name":"Jacob","color":"rgb(255, 113, 113)","radius":10},{"id":"8","name":"James","color":"rgb(255, 113, 255)","radius":10},{"id":"9","name":"Kelvin","color":"rgb(255, 227, 255)","radius":10},{"id":"10","name":"Kendall","color":"rgb(255, 255, 113)","radius":10},{"id":"11","name":"Kendrick","color":"rgb(255, 113, 113)","radius":10},{"id":"12","name":"Leroy","color":"rgb(255, 113, 255)","radius":10},{"id":"13","name":"Leslie","color":"rgb(255, 227, 255)","radius":10},{"id":"14","name":"Lester","color":"rgb(255, 255, 113)","radius":10},{"id":"15","name":"Magnus","color":"rgb(255, 113, 113)","radius":10},{"id":"16","name":"Malcolm","color":"rgb(255, 113, 255)","radius":10},{"id":"17","name":"Melvin","color":"rgb(255, 227, 255)","radius":10},{"id":"18","name":"Perry","color":"rgb(255, 255, 113)","radius":10},{"id":"19","name":"Peter","color":"rgb(255, 113, 113)","radius":10},{"id":"20","name":"Peyton","color":"rgb(255, 113, 255)","radius":10},{"id":"21","name":"Royce","color":"rgb(255, 227, 255)","radius":10},{"id":"22","name":"Rufus","color":"rgb(255, 255, 113)","radius":10},{"id":"23","name":"Rupert","color":"rgb(255, 113, 113)","radius":10},{"id":"24","name":"Hadden","color":"rgb(255, 113, 255)","radius":10},{"id":"25","name":"Hadley","color":"rgb(255, 227, 255)","radius":10},{"id":"26","name":"Hadwin","color":"rgb(255, 255, 113)","radius":10},{"id":"27","name":"Hal","color":"rgb(255, 113, 113)","radius":10},{"id":"28","name":"Halbert","color":"rgb(255, 113, 255)","radius":10},{"id":"29","name":"Halden","color":"rgb(255, 227, 255)","radius":10},{"id":"30","name":"Hale","color":"rgb(255, 255, 113)","radius":10},{"id":"31","name":"Gilroy","color":"rgb(255, 113, 113)","radius":10},{"id":"32","name":"Glenn","color":"rgb(255, 113, 255)","radius":10},{"id":"33","name":"Goddard","color":"rgb(255, 227, 255)","radius":10},{"id":"34","name":"Godfrey","color":"rgb(255, 255, 113)","radius":10},{"id":"35","name":"Godwin","color":"rgb(255, 113, 113)","radius":10},{"id":"36","name":"Graham","color":"rgb(255, 113, 255)","radius":10},{"id":"37","name":"Grant","color":"rgb(255, 227, 255)","radius":10},{"id":"38","name":"Tobias","color":"rgb(255, 255, 113)","radius":10},{"id":"39","name":"Toby","color":"rgb(255, 113, 113)","radius":10},{"id":"40","name":"Todd","color":"rgb(255, 113, 255)","radius":10},{"id":"41","name":"Tony","color":"rgb(255, 227, 255)","radius":10},{"id":"42","name":"Travis","color":"rgb(255, 255, 113)","radius":10},{"id":"43","name":"Trent","color":"rgb(255, 113, 113)","radius":10},{"id":"44","name":"Trevor","color":"rgb(255, 113, 255)","radius":10},{"id":"45","name":"Tristan","color":"rgb(255, 227, 255)","radius":10},{"id":"46","name":"Troy","color":"rgb(255, 255, 113)","radius":10},{"id":"47","name":"Truman","color":"rgb(255, 113, 113)","radius":10},{"id":"48","name":"Tyler","color":"rgb(255, 113, 255)","radius":10}] ),
            //     s.setLinks([{"source":0,"target":1},{"source":0,"target":2},{"source":0,"target":3},{"source":0,"target":4},{"source":2,"target":5},{"source":3,"target":6},{"source":4,"target":7},{"source":1,"target":8},{"source":2,"target":9},{"source":3,"target":10},{"source":4,"target":11},{"source":1,"target":12},{"source":2,"target":13},{"source":3,"target":14},{"source":4,"target":15},{"source":1,"target":16},{"source":2,"target":17},{"source":3,"target":18},{"source":4,"target":19},{"source":1,"target":20},{"source":2,"target":21},{"source":3,"target":22},{"source":4,"target":23},{"source":1,"target":24},{"source":2,"target":25},{"source":3,"target":26},{"source":4,"target":27},{"source":1,"target":28},{"source":2,"target":29},{"source":3,"target":30},{"source":4,"target":31},{"source":1,"target":32},{"source":2,"target":33},{"source":3,"target":34},{"source":4,"target":35},{"source":1,"target":36},{"source":2,"target":37},{"source":3,"target":38},{"source":4,"target":39},{"source":1,"target":40},{"source":2,"target":41},{"source":3,"target":42},{"source":4,"target":43},{"source":1,"target":44},{"source":2,"target":45},{"source":3,"target":46},{"source":4,"target":47},{"source":1,"target":48}]),
            //     s.setCanvas(canvas),
            //     s.setSize(width, height),
            //     s.setRadius(12),
            //     s.setLinkLength(90),
            //     s.setCharge(-60),
            //     s.init(),
            //     s.run()
            // })
        </script>
</div>
</body>
</html>
